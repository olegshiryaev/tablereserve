{% load i18n %}
<!DOCTYPE html>
<html lang="ru">

<head>
    {% load static %}
    <meta charset="UTF-8" />
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <!-- Lightbox CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet" />
    <link rel="apple-touch-icon" sizes="57x57" href="{% static 'favicons/apple-touch-icon-57x57.png' %}">
    <link rel="apple-touch-icon" sizes="60x60" href="{% static 'favicons/apple-touch-icon-60x60.png' %}">
    <link rel="apple-touch-icon" sizes="72x72" href="{% static 'favicons/apple-touch-icon-72x72.png' %}">
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'favicons/apple-touch-icon-76x76.png' %}">
    <link rel="apple-touch-icon" sizes="114x114" href="{% static 'favicons/apple-touch-icon-114x114.png' %}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'favicons/apple-touch-icon-120x120.png' %}">
    <link rel="apple-touch-icon" sizes="144x144" href="{% static 'favicons/apple-touch-icon-144x144.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'favicons/apple-touch-icon-152x152.png' %}">
    <link rel="icon" type="image/png" href="{% static 'favicons/favicon-32x32.png' %}" sizes="32x32">
    <link rel="icon" type="image/png" href="{% static 'favicons/favicon-96x96.png' %}" sizes="96x96">
    <link rel="icon" type="image/png" href="{% static 'favicons/favicon-16x16.png' %}" sizes="16x16">
    {% block extra_head %}{% endblock %}
</head>

<body>
    {% if messages %}
        <div class="toast-container top-0 end-0 p-3">
            {% for message in messages %}
                <div class="toast 
                    {% if 'error' in message.tags %} text-bg-danger {% else %} text-bg-{{ message.tags }} {% endif %}" 
                    role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            {{ message }}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% block navbar %}
    {% endblock %}
    <main>
        {% block content %}
        {% endblock %}
    </main>
    {% block footer %}
    {% endblock %}

    <script src="{% static 'js/script.js' %}"></script>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Lightbox JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        $(document).ready(function() {
            $(".toast").toast('show');
        });
    </script>

    <script>
        // Глобальная настройка CSRF для всех AJAX-запросов jQuery
        $.ajaxSetup({
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });

        // === ВХОД ===
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            $('#loginModal .error-message').empty();
            $('#loginModal .general-errors').empty();
            $('#loginModal .field-wrapper').removeClass('error');

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        window.location.href = response.redirect || '/';
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.errors) {
                        const errors = xhr.responseJSON.errors;
                        if (errors.non_field) {
                            errors.non_field.forEach(msg => {
                                $('#loginModal .general-errors').append(
                                    `<div class="error-message">${msg}</div>`
                                );
                            });
                        }
                        Object.keys(errors).forEach(field => {
                            if (field === 'non_field') return;
                            const $wrapper = $(`#id_${field}`).closest('.field-wrapper');
                            $wrapper.addClass('error');
                            errors[field].forEach(msg => {
                                $wrapper.find('.error-message').append(`<span>${msg}</span>`);
                            });
                        });
                    } else {
                        $('#loginModal .general-errors').html(
                            '<div class="error-message">Произошла ошибка. Попробуйте позже.</div>'
                        );
                    }
                }
            });
        });

        // === РЕГИСТРАЦИЯ ===
        $(document).on('submit', '#registerForm', function(e) {
            e.preventDefault();

            const $form = $(this);
            const $modal = $('#registerModal');

            $modal.find('.general-errors').empty();
            $modal.find('.field-error').empty();
            $modal.find('input').removeClass('error');

            $.ajax({
                type: 'POST',
                url: $form.attr('action'),
                data: $form.serialize(),

                success: function(response) {
                    if (response.success) {
                        window.location.href = response.redirect || '/';
                    }
                },

                error: function(xhr) {
                    if (xhr.status === 400 && xhr.responseJSON?.errors) {
                        const errors = xhr.responseJSON.errors;

                        for (const [field, messages] of Object.entries(errors)) {
                            if (field === 'non_field_errors') {
                                messages.forEach(msg => {
                                    $modal.find('.general-errors')
                                        .append(`<div class="error-message">${msg}</div>`);
                                });
                            } else {
                                const $input = $form.find(`[name="${field}"]`);
                                $input.addClass('error');

                                $input.next('.field-error')
                                    .html(messages.join('<br>'));
                            }
                        }
                    } else {
                        $modal.find('.general-errors').html(
                            '<div class="error-message">Произошла ошибка. Попробуйте позже.</div>'
                        );
                    }
                }
            });
        });

        // Показать/скрыть пароль — вход
        $('#showPasswordLogin').on('change', function() {
            const type = this.checked ? 'text' : 'password';
            $('#id_password').attr('type', type);
        });

        // Показать/скрыть пароль — регистрация
        $('#showPasswordRegister').on('change', function() {
            const type = this.checked ? 'text' : 'password';
            $('#regPassword').attr('type', type);
        });

        // Открытие модалки входа
        $(document).on('click', '#loginButtonDesktop, #loginButtonMobile', function(e) {
            e.preventDefault();
            $('#loginModal').css('display', 'block');
            $('#id_username').focus();
        });

        // Закрытие модалок
        $(document).on('click', '.modal .close, .modal', function(e) {
            if (e.target === this || $(e.target).hasClass('close')) {
                $(this).css('display', 'none');
            }
        });

        // Автооткрытие при ошибках
        $(document).ready(function() {
            const hasVisibleErrors = $('#loginModal .error-message, #loginModal .general-errors')
                .toArray()
                .some(el => $(el).text().trim() !== '');
            const urlParams = new URLSearchParams(window.location.search);
            const hasErrorParam = urlParams.has('error');
            if (hasVisibleErrors || hasErrorParam) {
                $('#loginModal').css('display', 'block');
                $('#id_username').focus();
            }
        });
    </script>

    <!-- Vanilla JS для UI (меню, гамбургер и т.д.) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cityDropdownToggle = document.getElementById('cityDropdownToggle');
            const userDropdownToggle = document.getElementById('userDropdownToggle');
            const loginButtonDesktop = document.getElementById('loginButtonDesktop');
            const loginButtonMobile = document.getElementById('loginButtonMobile');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const forgotPasswordModal = document.getElementById('forgotPasswordModal');
            const resetPasswordDoneModal = document.getElementById('resetPasswordDoneModal');
            const modalCloseButtons = document.querySelectorAll('.modal .close');
            const regNameInput = document.getElementById('regName');
            const switchToLogin = document.getElementById('switchToLogin');
            const switchToRegister = document.getElementById('switchToRegister');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');

            // Переключение модалок
            if (switchToLogin) {
                switchToLogin.addEventListener('click', function(event) {
                    event.preventDefault();
                    registerModal.style.display = 'none';
                    loginModal.style.display = 'block';
                    document.getElementById('id_username')?.focus();
                });
            }

            if (switchToRegister) {
                switchToRegister.addEventListener('click', function(event) {
                    event.preventDefault();
                    loginModal.style.display = 'none';
                    registerModal.style.display = 'block';
                    regNameInput?.focus();
                });
            }

            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    loginModal.style.display = 'none';
                    forgotPasswordModal.style.display = 'block';
                    document.getElementById('resetEmail')?.focus();
                });
            }

            // Открытие входа
            function showLoginModal(event) {
                event.preventDefault();
                loginModal.style.display = 'block';
                document.getElementById('id_username')?.focus();
            }

            if (loginButtonDesktop) loginButtonDesktop.addEventListener('click', showLoginModal);
            if (loginButtonMobile) loginButtonMobile.addEventListener('click', showLoginModal);

            // Закрытие по крестику / клику вне
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                    registerModal.style.display = 'none';
                    forgotPasswordModal.style.display = 'none';
                    resetPasswordDoneModal.style.display = 'none';
                });
            });

            window.addEventListener('click', (event) => {
                if (event.target === loginModal) loginModal.style.display = 'none';
                if (event.target === registerModal) registerModal.style.display = 'none';
                if (event.target === forgotPasswordModal) forgotPasswordModal.style.display = 'none';
                if (event.target === resetPasswordDoneModal) resetPasswordDoneModal.style.display = 'none';
            });

            // Закрытие по Esc
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    loginModal.style.display = 'none';
                    registerModal.style.display = 'none';
                    forgotPasswordModal.style.display = 'none';
                    resetPasswordDoneModal.style.display = 'none';
                }
            });

            // Гамбургер
            const hamburger = document.querySelector('.hamburger');
            const mobileNav = document.querySelector('.mobile-nav');
            if (hamburger && mobileNav) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    mobileNav.classList.toggle('active');
                    hamburger.setAttribute('aria-expanded', mobileNav.classList.contains('active'));
                });

                document.addEventListener('click', (event) => {
                    if (!mobileNav.contains(event.target) && !hamburger.contains(event.target)) {
                        mobileNav.classList.remove('active');
                        hamburger.classList.remove('active');
                        hamburger.setAttribute('aria-expanded', false);
                    }
                });
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>